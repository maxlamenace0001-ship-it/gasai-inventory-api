<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>GasAI Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 960px;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 16px;
      padding: 16px 18px 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .step-pill {
      font-size: 0.75rem;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.5);
      color: #7dd3fc;
    }

    .card-title {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin: 4px 0 0;
    }

    .upload-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    input[type="file"] {
      font-size: 0.85rem;
    }

    .status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #fbbf24;
    }

    .status.ok {
      color: #4ade80;
    }

    .status.error {
      color: #f97373;
    }

    .log-box {
      margin-top: 12px;
      background: #020617;
      border-radius: 10px;
      padding: 8px 10px;
      font-family: "JetBrains Mono", Consolas, monospace;
      font-size: 0.75rem;
      color: #a5b4fc;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid rgba(55, 65, 81, 0.8);
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(31, 41, 55, 0.9);
    }

    th,
    td {
      padding: 6px 8px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      text-align: left;
    }

    th {
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.8);
    }

    tbody tr:nth-child(odd) {
      background: rgba(17, 24, 39, 0.9);
    }

    .shelf-state-select {
      width: 100%;
      font-size: 0.78rem;
      background: #020617;
      color: #e5e7eb;
      border-radius: 6px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 3px 4px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    @media (max-width: 640px) {
      .card {
        padding: 14px 12px 14px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .card-title {
        font-size: 0.98rem;
      }

      th,
      td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>GasAI Inventory</h1>
    <p class="subtitle">
      Scan rapide de rayon avec photo &nbsp;•&nbsp; Vue globale + réglage “tablette pleine”.
    </p>

    <!-- Étape 1 : upload photo overview -->
    <div class="card">
      <div class="card-header">
        <span class="step-pill">Étape 1</span>
        <div>
          <div class="card-title">Prendre une photo du rayon (overview)</div>
          <p class="hint">Photo large de l’étagère au complet. On fera les zooms plus tard si nécessaire.</p>
        </div>
      </div>

      <div class="upload-row">
        <input type="file" id="file-input" accept="image/*" capture="environment" />
      </div>

      <div id="status" class="status">En attente d’une image…</div>

      <div class="log-box" id="log">Page chargée.</div>
    </div>

    <!-- Étape 2 : tableau d’inventaire -->
    <div class="card">
      <div class="card-header">
        <span class="step-pill">Étape 2</span>
        <div>
          <div class="card-title">Résultat inventaire (vue globale)</div>
          <p class="hint">
            Chaque ligne = un type de produit. La colonne “Tablette” te permet de dire si c’est plein ou non.
          </p>
        </div>
      </div>

      <div id="inventory-container">
        <!-- Le tableau est injecté ici en JS -->
        <p class="hint">Aucun scan encore. Choisis une image pour voir l’inventaire.</p>
      </div>

      <p class="footer-note">
        Astuce : dans le futur, on pourra utiliser “Tablette pleine” pour auto-calculer la quantité par magasin.
      </p>
    </div>
  </div>

  <script>
    // ✅ Nouvelle ligne : URL de l’API sur Railway
    const API_URL = "https://gasai-inventory-api-production.up.railway.app";

    const fileInput = document.getElementById("file-input");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const inventoryContainer = document.getElementById("inventory-container");

    function logLine(msg) {
      const time = new Date().toLocaleTimeString();
      const line = "[" + time + "] " + msg;
      console.log(line);
      logEl.textContent += "\n" + line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    logLine("Interface prête.");

    fileInput.addEventListener("change", async () => {
      if (fileInput.files.length === 0) {
        statusEl.textContent = "Aucun fichier sélectionné.";
        statusEl.className = "status";
        logLine("Aucun fichier.");
        return;
      }

      const file = fileInput.files[0];
      statusEl.textContent = "Analyse en cours…";
      statusEl.className = "status";
      logLine("Fichier choisi : " + file.name);

      const formData = new FormData();
      formData.append("file", file);

      try {
        logLine("Envoi vers /analyze sur Railway …");

        // ✅ ICI la vraie modif importante
        const response = await fetch(`${API_URL}/analyze`, {
          method: "POST",
          body: formData,
        });

        logLine("Réponse HTTP status: " + response.status);

        const data = await response.json();
        logLine("Réponse JSON : " + JSON.stringify(data, null, 2));

        if (data.error) {
          statusEl.textContent = "Erreur API : " + data.error;
          statusEl.className = "status error";
          return;
        }

        statusEl.textContent = "Analyse terminée ✔️";
        statusEl.className = "status ok";

        afficherInventaire(data.inventory || []);
      } catch (err) {
        statusEl.textContent = "Erreur : " + err;
        statusEl.className = "status error";
        logLine("Erreur JS : " + err);
      }
    });

    function afficherInventaire(inventory) {
      // Reset container
      inventoryContainer.innerHTML = "";

      if (!inventory.length) {
        const p = document.createElement("p");
        p.className = "hint";
        p.textContent = "Aucun produit détecté dans cette image.";
        inventoryContainer.appendChild(p);
        return;
      }

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Produit</th>
            <th>Marque</th>
            <th>Quantité estimée</th>
            <th>Position</th>
            <th>Confiance</th>
            <th>Tablette</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      inventory.forEach((item) => {
        const row = document.createElement("tr");
        const label = item.label || "";
        const brand = item.brand || "";
        const qty = item.estimated_quantity ?? "";
        const pos = item.position || "";
        const conf = item.confidence ?? "";

        // cellule “état tablette”
        const shelfSelect = document.createElement("select");
        shelfSelect.className = "shelf-state-select";
        ["--", "pleine", "à moitié", "presque vide"].forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt;
          if (opt === "pleine") o.selected = true;
          shelfSelect.appendChild(o);
        });

        row.innerHTML = `
          <td>${label}</td>
          <td>${brand}</td>
          <td>${qty}</td>
          <td>${pos}</td>
          <td>${conf}</td>
        `;

        const shelfCell = document.createElement("td");
        shelfCell.appendChild(shelfSelect);

        row.appendChild(shelfCell);
        tbody.appendChild(row);
      });

      inventoryContainer.appendChild(table);
    }
  </script>
</body>

</html>